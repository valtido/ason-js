/*! jom 0.0.2 |                  @author Valtid Caushi                  @date 10-08-2015 */

var Observe;Observe=function(){function a(b,c,d,e){var f,g,h,i,j,k,l;if(null==d&&(d=null),null==e&&(e=null),d=d||b,!b)throw new Error("Observe: Object missing.");if("function"!=typeof c)throw new Error("Observe: Callback should be a function.");if(l=d.constructor.name,"Array"===l)for(f=e,i=h=0,j=d.length;j>h;i=++h)g=d[i],"object"==typeof g&&(k=(f||"")+"["+i+"]",new a(b,c,g,k),k="");if("Object"===l){f=e;for(i in d)g=d[i],"object"==typeof g&&(f&&(k=f+"."+i),f||(k=""+i),new a(b,c,g,k),k="")}"Array"===d.constructor.name?(f=e,Array.observe(d,function(d){var e,g;return g={},e={},d.forEach(function(d,h){var i,j,l;return i=d.index>-1?d.index:d.name,k=(f||"")+"["+i+"]",l={path:k,value:d.object[d.index]||d.object[d.name]||d.object},j=d.addedCount>0||"add"===d.type,"object"==typeof l.value&&j&&(new a(b,c,l.value,l.path),k=""),g[h]=l,e[h]=d}),c(g,e)})):"Object"===d.constructor.name&&(f=e,Object.observe(d,function(d){var e,g;return g={},e={},d.forEach(function(d,h){var i,j;return f&&(k=f+"."+d.name),f||(k=""+d.name),j={path:k,value:d.object[d.name]},i="add"===d.type||d.addedCount>0,"object"==typeof j.value&&i&&(new a(b,c,j.value,j.path),k=""),g[h]=j,e[h]=d}),c(g,e)}))}return a}(),Function.prototype.getter=function(a,b){return Object.defineProperty(this.prototype,a,{get:b,configurable:!0,enumerable:!1})},Function.prototype.setter=function(a,b){return Object.defineProperty(this.prototype,a,{set:b,configurable:!0,enumerable:!1})},Function.prototype.property=function(a,b){return Object.defineProperty(this.prototype,a,b)},null==$.fn.findAll&&($.fn.findAll=function(a){return this.find(a).add(this.filter(a))}),null==$.fn.value&&($.fn.value=function(a,b){var c;return null==b&&(b=!1),console.info("go back to value change how it works"),a?($(this).data("value",arguments[0]),b===!0&&(c=$.trim(a),$(this).text(c)),$(this).trigger("jom.change"),$(this)):$(this).data("value")});var Asset,indexOf=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};Asset=function(){a.name=null,a.source="",a.origin="",a.content_type={},a.element={};function a(a){var b,c,d,e,f,g,h;if(b=$(a),this.rel=b.attr("rel"),void 0===this.rel)throw new Error("jom: rel=asset is required");if(this.name=b.attr("name")||null,this.source=b.attr("source"),this.asset=b.attr("asset"),this.original=a,this.clone=b.clone(),h=b.attr("type"),void 0===h)throw new Error("jom: asset type is required");switch(g=h.split(";"),e=$.trim(g[0]),d=$.trim(g[1])||null,this.content_type={full:h,part:e,type:e.split("/")[0],media:e.split("/")[1],params:d},b.get(0).asset=!0,this.element=this.create_element(),this.content_type.part){case"text/html":this.error("name"),this.error("source"),this.error("asset");break;case"text/json":this.error("name"),this.error("source"),this.error("asset");break;default:this.error("source")}if(c=["schema","collection","template","javascript","css","img","plain"],this.asset&&(f=this.asset,indexOf.call(c,f)>=0==!1))throw new Error("jom: asset attr '"+this.asset+"' is not valid")}return a.prototype.error=function(a){var b;if(b=["name","source","asset"],indexOf.call(b,a)>=0&&void 0===this[a])throw new Error("jom: "+a+" attr is required")},a.prototype.create_element=function(){var a;switch(this.content_type.part){case"text/html":a="<link    rel=import href='"+this.source+"' type='text/html' name='"+this.name+"' asset='"+this.asset+"' />";break;case"text/css":a="<link    href='"+this.source+"' rel='stylesheet' type='text/css' name='"+this.name+"' asset='"+this.asset+"' />";break;case"text/javascript":a="<script  src='"+this.source+"' type='text/javascript' async=true name='"+this.name+"' asset='"+this.asset+"' />";break;case"text/json":a="<script  source='"+this.source+"' type='"+this.content_type.part+"' async='true' name='"+this.name+"' asset='"+this.asset+"' />";break;case"text/plain":a="<script  type='"+this.content_type.part+"' async='true' name='"+this.name+"' asset='"+this.asset+"' />";break;default:throw a=null,"undefined"!=typeof console&&null!==console&&"function"==typeof console.warn&&console.warn("media: ",this.content_type.part),new Error("jom: asset media `"+this.content_type.full+"` type is not valid")}return a},a}();var Shadow;Shadow=function(){function a(){var a,b,c,d,e;this.root=(null!=(a=document.currentScript)?a.parentNode:void 0)||(null!=(b=arguments.callee)&&null!=(c=b.caller)&&null!=(d=c.caller)&&null!=(e=d.arguments[0])?e.target:void 0)||null,this.traverseAncestry(),this.root}return a.prototype.traverseAncestry=function(a){var b;return(null!=(b=this.root)?b.parentNode:void 0)||a?(this.root=this.root.parentNode||a,this.traverseAncestry(this.root.parentNode)):void 0},a.getter("body",function(){return $(this.root).children().filter("[body]").get(0)||null}),a.getter("host",function(){var a;return(null!=(a=this.root)?a.host:void 0)||null}),a}(),Object.defineProperty(window,"Root",{get:function(){return new Shadow}});var Collection;Collection=function(){var a;b.name="",b.data=[],b.schema={},b.errors=null,b.observing=!1,a=jjv();function b(a,b,c){if(null==b&&(b=[]),null==c&&(c={}),void 0===a||!a||"string"!=typeof a)throw new Error("jom: collection name is required");this.name=a,this.data=[],this.schema={},this.attach_schema(c),this.attach_data(b),this.errors=null,this.observing=!1}return b.prototype.generate_id=function(){return(new Date).getTime()},b.prototype.meta=function(){return{id:this.generate_id()}},b.prototype.attach_data=function(a){var b,c,d,e;if(null==a&&(a=[]),e=a.length||Object.keys(a).length)if(Array.isArray(a))for(b=0,d=a.length;d>b;b++)c=a[b],c.meta=this.meta(),Object.defineProperty(c,"meta",{enumerable:!1}),this.data.push(c);else a.meta=this.meta(),Object.defineProperty(a,"meta",{enumerable:!1}),this.data.push(a);return this.data},b.prototype.attach_schema=function(a){if(null==a&&(a={}),void 0===a)throw new Error("collection: schema is missing");return this.schema=a},b.prototype.errors_to_string=function(){return JSON.stringify(this.errors)},b.prototype.is_valid=function(){var b;if(a=jjv(),b=Object.keys(this.schema).length,0===b)return!0;if(void 0===this.schema.$schema)throw new Error("jom: $schema is missing");return a.addSchema(this.name,this.schema),this.errors=a.validate(this.name,this.data),this.errors?!1:!0},b.prototype.join=function(a,b){var c,d,e,f,g;return f=this.join,b=""+b,e=b[0],g="["===e?a+b:a+"."+b,arguments.length>2&&(c=Array.prototype.splice.call(arguments,2),d=[],d.push(g),d.push.apply(d,c),g=this.join.apply(this,d)),g},b.prototype.findByPath=function(a){var b,c,d,e,f,g,h;for(e=/(\[)(\d+)(\])/g,h=a.replace(e,".$2").replace(/^\.*/,""),g=h.split("."),f=this.data,b=0,d=g.length;d>b;b++){if(c=g[b],void 0===f)return f;f=f[c]}return f},b}();var Component;Component=function(){var a,b,c;a=!1,b=/\${([^\s{}]+)}/,c=/\${([^\s{}]+)}/g;function d(a){var b,c,d,e;if(void 0===a)throw new Error("jom: component is required");if(b=$(a),b.get(0).component=!0,e=b.attr("template"),c=b.attr("collections"),d=b.attr("path"),!e)throw new Error("jom: component template is required");if(!c)throw new Error("jom: component collections is required");this.attr={template:e,collections:c},c=c.split(/\s*,\s*/g),this.collections_list=c,this.element=b.get(0),this.element.createShadowRoot||(this.element=wrap(this.element)),this.hide(),this.ready=!1,this.template=null,this.collections={},this.path=d||"[0]",this.data=[],this.create_shadow(),this.root=this.element.shadowRoot,this.template_ready=!1,this.collections_ready=!1,this.handles=[],this.events=[],this.scripts=[],this.scripts.status="init"}return d.prototype.hide=function(){var a;return a=$(this.root),a.find("")},d.prototype.show=function(){},d.prototype.enable=function(){return a=!1},d.prototype.disable=function(){return a=!0},d.prototype.destroy=function(){},d.prototype.create_shadow=function(){return this.element.createShadowRoot()},d.prototype.define_template=function(a){if(!a||a instanceof Template==!1)throw new Error("jom: template cant be added");return this.template=a},d.prototype.define_collection=function(a){if(!a||a instanceof Collection==!1)throw new Error("jom: collection cant be added");return void 0===this.collections[a.name]&&(this.collections[a.name]=a),this.collections},d.prototype.watcher=function(a,b){var c,d,e;if(b.name===this.collection.name){e=[];for(d in a)c=a[d],e.push(c.path.slice(0,this.path.length)===this.path?$(this.handles).each(function(a){return function(b,d){var e,f,g,h,i,j,k,l,m;if(d.handle.path===c.path){for($(d).trigger("change",c),j=c.path.replace(a.path,"").replace(/^\./,""),k=a.events,f=0,h=k.length;h>f;f++)e=k[f],"change:before"===e.type&&e.path===j&&e.callback.call(a);switch(d.handle.type){case"attr_name":$(d).attr(d.handle.attr.name,"");break;case"attr_value":$(d).attr(d.handle.attr.name,c.value);break;case"node":$(d).text(c.value);break;default:throw new Error("jom: unexpected handle type")}for(l=a.events,m=[],g=0,i=l.length;i>g;g++)e=l[g],m.push("change"===e.type&&e.path===j?e.callback.call(a):void 0);return m}}}(this)):void 0);return e}},d.prototype.handlebars=function(a,c){var d,e,f;return f=c.collections,d=$(a),e=d.findAll("*").not("script, style, link, [repeat]").filter(function(){return 0===$(this).parents("[repeat]").length}),e.each(function(a){return function(c,d){var e,g,h,i,j,k,l,m,n,o,p,q,r,s,t;if(t=$(d).text(),0===$(d).children().length&&b.test(t)===!0){if(o=t,j=t.match(b)[1],p=j.split(":"),g=p[0],n=p[1],void 0===g)throw new Error("component: `"+o+"` is wrong, start with collection.");if(g=f[g],m=g.findByPath($.trim(n)),void 0===m){if("production"!==jom.env)throw new Error("Data: not found for `"+o+"` key.");m=""}$(d).text(t.replace(b,m)),d.handle={type:"node",path:n,full:g.join(g.name,n)},a.handles.push(d)}for(q=d.attributes,j=i=0,k=q.length;k>i;j=++i){if(e=q[j],b.test(e.name)){t=e.name,o=t;try{j=t.match(b)[1]}catch(u){throw h=u,new Error("Component: wrong key on attr name "+t)}if(r=j.split(":"),g=r[0],n=r[1],void 0===g)throw new Error("component: `"+o+"` is wrong, start with collection.");g=f[g],m=g.findByPath($.trim(n)),void 0===m&&"production"===jom.env&&(m=""),l=t.replace(b,m),$(d).removeAttr(e.name).attr(l,e.value),d.handle={attr:e,type:"attr_name",path:n,full:g.join(g.name,n)},a.handles.push(d)}if(b.test(e.value)){t=e.value,o=t;try{j=t.match(b)[1]}catch(u){throw h=u,new Error("Component: wrong key on attr value "+t)}if(s=j.split(":"),g=s[0],n=s[1],void 0===g)throw new Error("component: `"+o+"` is wrong, start with collection.");g=f[g],m=g.findByPath($.trim(n)),void 0===m&&"production"===jom.env&&(m=""),e.value=t.replace(b,m),d.handle={attr:e,type:"attr_value",path:n,full:g.join(g.name,n)},a.handles.push(d)}}return d}}(this)),d},d.prototype.handle_template_scripts=function(a){var b,c;return this.scripts.status="waiting",b=function(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},c=$(a).find("script"),$(c).filter("[src]").each(function(a,b){return b.onload=function(){return b.has_loaded=!0}}),$(c).not("[src]").eq(0).each(function(a,c){var d,e,f;return d="",f=new RegExp("^"+b(d)),e=f.test(c.text),c.text="(function(){\nvar\nshadow      = jom.shadow,\nbody        = shadow.body,\nhost        = shadow.host,\nroot        = shadow.root,\ncomponent   = host.component,\ncollections = component.collections\n;\n\n"+c.text+"\n})()",c})},d.prototype.on=function(a,b,c){var d,e,f,g;for(g=a.split(" "),e=0,f=g.length;f>e;e++)a=g[e],d={type:a,path:b,callback:c},this.events.push(d);return this},d.prototype.trigger=function(a,b){var c,d,e,f,g,h,i,j,k,l,m;for(null==b&&(b={}),m=a.split(" "),e=0,h=m.length;h>e;e++)for(a=m[e],k=this.events,f=0,i=k.length;i>f;f++)if(c=k[f],a===c.type)for(l=this.handles,g=0,j=l.length;j>g;g++)d=l[g],-1!==d.handle.path.indexOf(c.path)&&c.callback.call(d,c,b);return this},d.prototype.repeat=function(a,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;if(null==c&&(c=null),null===c&&(c=[]),d=$(a),k=d.attr("repeat"),o=k,void 0===k)throw new Error("component: `repeat` attr missing");try{k=k.match(b)[1]}catch(s){throw g=s,new Error("Component: Wrong key `"+k+"`")}if(q=$([]),p=k.split(":"),f=p[0],m=p[1],void 0===f)throw new Error("component: `"+o+"` is wrong, start with collection.");if(c=void 0!==m&&m.length?this.collections[f].findByPath(m):this.collections[f].data,void 0===c)throw new Error("component: data not found `"+m+"`");for(void 0===m&&(m=""),h=j=0,l=c.length;l>j;h=++j)i=c[h],e=d.clone(),e.attr("repeated",!0),e.attr("repeat",null),e.attr("repeat-index",h),n=this.collections[f].join(m,"["+h+"]"),n=f+":"+n,r=e[0].outerHTML.replace(/(\${)([^\s{}]+)(})/g,"$1"+n+".$2$3"),r=r.replace(/(\{repeat\.index})/g,h),r=r.replace(/(\{repeat\.length})/g,c.length),q=q.add(r);return q},d}();var Template;Template=function(){function a(a){var b,c;if(null==a&&(a=null),b=$(a),0===b.length)throw new Error("jom: template is required");if(this.name=b.attr("name"),void 0===this.name)throw new Error("jom: template name attr is required");if(c=b.get(0),this.element=document.importNode(c.content,!0),this.body=$(this.element).children("[body]"),b.get(0).template=!0,void 0===this.body||0===this.body.length)throw new Error("jom: template body attr is required");if(this.schema=$(this.element).children("link[rel=asset][asset=schema]"),0===this.schema.length)throw new Error("jom: template schema(s) are required");this.cloned=null}return a.prototype.clone=function(){return this.cloned=this.element.cloneNode(!0)},a}();var JOM,jom;JOM=function(){var a;a={};function b(){window.jom=this,$("html").append("<foot/>"),this.templates=[],this.collections=[],this.components=[],this.assets=[],this.schemas=[],this.tasks(),this.env="production",this.app={title:"JOM is Awesome"}}return b.prototype.tasks=function(){return setTimeout(function(a){return function(){return a.load_assets(),a.load_components(),a.load_templates(),a.load_collections(),a.load_schemas,a.inject_assets(),a.assemble_components(),a.watch_collections(),a.tasks()}}(this),100)},b.prototype.inject_assets=function(){return $.each(this.assets,function(a,b){var c;return null!=b.queued!=!0?(b.queued=!0,c=$("html>foot"),"text/json"===b.content_type.part&&$.getJSON(b.source).done(function(a){return c.find("script[source='"+b.source+"']").get(0).data=a}),c.append(b.element)):void 0})},b.prototype.load_assets=function(){return $('head link[rel="asset"]').each(function(a){return function(b,c){var d;return d=$(a.assets).filter(function(){return a.source===$(c).attr("source")}),"asset"in c==!1&&0===d.length?(c.asset=!0,a.assets.push(new Asset(c))):void 0}}(this))},b.prototype.load_schemas=function(){return $("foot script[asset=schema]").each(function(a){return function(b,c){return"schema"in c==!1?(c.schema=!0,a.schemas.push(c.json||{})):void 0}}(this))},b.prototype.load_components=function(){return $("component").each(function(a){return function(b,c){var d;return"component"in c==!1?(c.component=!0,d=new Component(c),a.components.push(d),c.component=d):void 0}}(this))},b.prototype.load_templates=function(){return $("foot link[rel=import][asset=template]").filter(function(a,b){return null!==b["import"]}).each(function(a){return function(b,c){var d,e;return e=c["import"].querySelector("template"),"template"in e==!1&&void 0!==c["import"]?(e.template=!0,d=$(e).attr("name"),a.templates[d]=new Template(e)):void 0}}(this))},b.prototype.load_collections=function(){return $("foot script[type='text/json'][asset=collection]").each(function(a){return function(b,c){var d,e;return"collection"in c==!1&&void 0!==c.data?(c.collection=!0,e=$(c).attr("name"),d=c.data,a.collections[e]=new Collection(e,d)):void 0}}(this))},b.prototype.assemble_components=function(){return $.each(this.components,function(a){return function(b,c){var d,e,f,g,h,i,j,k,l;if(c.ready!==!0&&"init"===c.scripts.status){for(l=jom.templates[c.attr.template],e=!0,0===c.collections_list.length&&e(!1),j=c.collections_list,f=0,h=j.length;h>f;f++)d=j[f],void 0===jom.collections[d]&&(e=!1);if(void 0!==l&&e===!0){for(c.define_template(l),k=c.collections_list,g=0,i=k.length;i>g;g++)d=k[g],c.define_collection(jom.collections[d]);return c.template.clone(),a.repeater(c),c.hide(),c.root.appendChild($("<div>Loading...</div>").get(0)),c.handlebars(c.template.cloned,c),$(c.root.children).remove(),c.handle_template_scripts(c.template.cloned),c.root.appendChild(c.template.cloned),a.image_source_change(c),a.wait_for_scripts(c)}}}}(this))},b.prototype.wait_for_scripts=function(a){return"done"===a.scripts.status?(a.show(),a.ready=!0,a.trigger("ready")):setTimeout(function(b){return function(){var c,d;return c=!0,d=$("script[src]",a.root),$(d).each(function(a,b){return null!=b.has_loaded!=!0?c=!1:void 0}),c===!0&&(a.scripts.status="done"),b.wait_for_scripts(a)}}(this),10)},b.prototype.image_source_change=function(a){return $("[body] img",a.root).not("[repeat] img").each(function(a,b){var c;return c=$(b),c.attr("src",c.attr("source"))})},b.prototype.repeater=function(a,b){return null==b&&(b=null),$("[body] [repeat]",b||a.template.cloned).each(function(b,c){var d;return c=$(c),d=a.repeat(c),d.insertAfter(c),c.hide()})},b.prototype.watch_collections=function(){var a,b,c,d;c=this.collections,d=[];for(b in c)a=c[b],a.observing===!1?(a.observing=!0,d.push(new Observe(a.data,function(a){return function(c){var d,e;e=[];for(b in c)d=c[b],e.push($.each(a.components,function(b,c){return $(c.root).find("[repeated]").remove(),$(c.root).find("[repeat]").show(),a.repeater(c,c.root),c.handlebars(c.root,c),a.image_source_change(c),$(c.root.host).trigger("change",[d,c.data,c.collection]),$(c.root).find("[repeat]").hide(),c.trigger("change",d)}));return e}}(this)))):d.push(void 0);return d},b.prototype.resolve=function(a){var b,c,d,e,f,g;switch(c=location.href,d=c.replace(location.protocol+"//","").replace(location.host,""),g=d,b=a[0],f=a[1],e="",b){case"/":"/"!==f&&(e=a);break;default:e=g.replace(/([\/]?[^\/]+[\/]?)$/g,"/"+a)}return e},b.getter("shadow",function(){return new Shadow}),b}(),jom=JOM=new JOM;
//# sourceMappingURL=jom.min.js.map