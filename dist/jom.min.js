/*! jom 0.0.2 |                  @author Valtid Caushi                  @date 28-04-2015 */

var Observe;Observe=function(){function a(b,c,d,e){var f,g,h,i,j,k,l;if(null==d&&(d=null),null==e&&(e=null),d=d||b,!b)throw new Error("Observe: Object missing.");if("function"!=typeof c)throw new Error("Observe: Callback should be a function.");if(j=d.constructor.name,"Array"===j)for(f=e,h=k=0,l=d.length;l>k;h=++k)g=d[h],"object"==typeof g&&(i=(f||"")+"["+h+"]",new a(b,c,g,i),i="");if("Object"===j){f=e;for(h in d)g=d[h],"object"==typeof g&&(f&&(i=f+"."+h),f||(i=""+h),new a(b,c,g,i),i="")}"Array"===d.constructor.name?(f=e,Array.observe(d,function(d){var e,g;return g={},e={},d.forEach(function(d,h){var j,k,l;return j=d.index>-1?d.index:d.name,i=(f||"")+"["+j+"]",l={path:i,value:d.object[d.index]||d.object[d.name]||d.object},k=d.addedCount>0||"add"===d.type,"object"==typeof l.value&&k&&(new a(b,c,l.value,l.path),i=""),g[h]=l,e[h]=d}),c(g,e)})):"Object"===d.constructor.name&&(f=e,Object.observe(d,function(d){var e,g;return g={},e={},d.forEach(function(d,h){var j,k;return f&&(i=f+"."+d.name),f||(i=""+d.name),k={path:i,value:d.object[d.name]},j="add"===d.type||d.addedCount>0,"object"==typeof k.value&&j&&(new a(b,c,k.value,k.path),i=""),g[h]=k,e[h]=d}),c(g,e)}))}return a}(),Function.prototype.getter=function(a,b){return Object.defineProperty(this.prototype,a,{get:b,configurable:!0,enumerable:!1})},Function.prototype.setter=function(a,b){return Object.defineProperty(this.prototype,a,{set:b,configurable:!0,enumerable:!1})},Function.prototype.property=function(a,b){return Object.defineProperty(this.prototype,a,b)},null==$.fn.findAll&&($.fn.findAll=function(a){return this.find(a).add(this.filter(a))}),null==$.fn.value&&($.fn.value=function(a,b){var c;return null==b&&(b=!1),console.log("go back to value change how it works"),a?($(this).data("value",arguments[0]),b===!0&&(c=$.trim(a),$(this).text(c)),$(this).trigger("jom.change"),$(this)):$(this).data("value")});var Asset;Asset=function(){a.name=null,a.source="",a.origin="",a.content_type={},a.element={};function a(a){var b,c,d,e,f;if(b=$(a),this.rel=b.attr("rel"),void 0===this.rel)throw new Error("jom: rel=asset is required");if(this.name=b.attr("name")||null,this.source=b.attr("source"),this.origin=b.clone(),f=b.attr("type"),void 0===f)throw new Error("jom: asset type is required");e=f.split(";"),d=$.trim(e[0]),c=$.trim(e[1])||null,this.content_type={full:f,part:d,type:d.split("/")[0],media:d.split("/")[1],params:c},b.get(0).asset=!0,this.element=this.create_element()}return a.prototype.create_element=function(){var a,b;switch(b=this.content_type.part){case"text/template":a="<link    rel=import href='"+this.source+"' type='text/template' />";break;case"text/css":a="<link    href='"+this.source+"' rel='stylesheet' type='text/css' />";break;case"text/javascript":a="<script  src='"+this.source+"' type='text/javascript' async=true />";break;case"text/json":a="<script  source='"+this.source+"' type='"+b+"' async='true' name='"+this.name+"' />";break;case"text/plain":a="<script  type='"+b+"' async='true' />";break;default:throw a=null,"undefined"!=typeof console&&null!==console&&"function"==typeof console.warn&&console.warn("media: ",b),new Error("jom: asset media `"+this.content_type.full+"` type is not valid")}return a},a}();var Shadow;Shadow=function(){function a(){var a,b,c,d,e;this.root=(null!=(a=document.currentScript)?a.parentNode:void 0)||(null!=(b=arguments.callee)&&null!=(c=b.caller)&&null!=(d=c.caller)&&null!=(e=d.arguments[0])?e.target:void 0)||null,this.traverseAncestry(),this.root}return a.prototype.traverseAncestry=function(a){var b;return(null!=(b=this.root)?b.parentNode:void 0)||a?(this.root=this.root.parentNode||a,this.traverseAncestry(this.root.parentNode)):void 0},a.getter("body",function(){return $(this.root).children().filter("[body]").get(0)||null}),a.getter("host",function(){var a;return(null!=(a=this.root)?a.host:void 0)||null}),a}(),Object.defineProperty(window,"Root",{get:function(){return new Shadow}});var Collection;Collection=function(){var a;b.name="",b.data=[],b.schema={},b.errors=null,b.observing=!1,a=jjv();function b(a,b,c){if(null==b&&(b=[]),null==c&&(c={}),void 0===a||!a||"string"!=typeof a)throw new Error("jom: collection name is required");this.name=a,this.data=[],this.schema={},this.attach_schema(c),this.attach_data(b),this.errors=null,this.observing=!1}return b.prototype.attach_data=function(a){var b,c,d,e;if(null==a&&(a=[]),c=a.length||Object.keys(a).length)if(Array.isArray(a))for(d=0,e=a.length;e>d;d++)b=a[d],this.data.push(b);else this.data.push(a);return this.data},b.prototype.attach_schema=function(a){return null==a&&(a={}),this.schema=a},b.prototype.errors_to_string=function(){return JSON.stringify(this.errors)},b.prototype.is_valid=function(){var b;if(a=jjv(),b=Object.keys(this.schema).length,0===b)return!0;if(void 0===this.schema.$schema)throw new Error("jom: $schema is missing");return a.addSchema(this.name,this.schema),this.errors=a.validate(this.name,this.data),this.errors?!1:!0},b.prototype.join=function(a,b){var c,d,e,f,g;return f=this.join,b=""+b,e=b[0],g="["===e?a+b:a+"."+b,arguments.length>2&&(c=Array.prototype.splice.call(arguments,2),d=[],d.push(g),d.push.apply(d,c),g=this.join.apply(this,d)),g},b.prototype.findByPath=function(a){var b,c,d,e,f,g,h;for(c=/(\[)(\d+)(\])/g,f=a.replace(c,".$2").replace(/^\.*/,""),e=f.split("."),d=this.data,g=0,h=e.length;h>g;g++){if(b=e[g],void 0===d)return d;d=d[b]}return d},b}();var Component;Component=function(){var a,b,c;a=!1,b=/\${([^\s{}]+)}/,c=/\${([^\s{}]+)}/g;function d(a){var b,c,d,e;if(void 0===a)throw new Error("jom: component is required");if(b=$(a),b.get(0).component=!0,e=b.attr("template"),c=b.attr("collection"),d=b.attr("path"),!e)throw new Error("jom: component template is required");if(!c)throw new Error("jom: component collection is required");this.attr={template:e,collection:c},this.element=b.get(0),this.element.createShadowRoot||(this.element=wrap(this.element)),this.hide(),this.ready=!1,this.template=null,this.collection=null,this.path=d||"[0]",this.data=[],this.create_shadow(),this.root=this.element.shadowRoot,this.template_ready=!1,this.collection_ready=!1,this.handles=[],this.events=[],this.scripts=[],this.scripts.status="init"}return d.prototype.hide=function(){var a;return a=$(this.root),a.find("")},d.prototype.show=function(){},d.prototype.enable=function(){return a=!1},d.prototype.disable=function(){return a=!0},d.prototype.destroy=function(){},d.prototype.create_shadow=function(){return this.element.createShadowRoot()},d.prototype.define_template=function(a){if(!a||a instanceof Template==!1)throw new Error("jom: template cant be added");return this.template=a},d.prototype.define_collection=function(a){if(!a||a instanceof Collection==!1)throw new Error("jom: collection cant be added");return this.collection=a,this.data=this.collection.findByPath(this.path),this.collection},d.prototype.watcher=function(a,b){var c,d,e;if(b.name===this.collection.name){e=[];for(d in a)c=a[d],e.push(c.path.slice(0,this.path.length)===this.path?$(this.handles).each(function(a){return function(b,d){var e,f,g,h,i,j,k,l,m;if(d.handle.path===c.path){for($(d).trigger("change",c),j=c.path.replace(a.path,"").replace(/^\./,""),k=a.events,f=0,h=k.length;h>f;f++)e=k[f],"change:before"===e.type&&e.path===j&&e.callback.call(a);switch(d.handle.type){case"attr":$(d).attr(d.handle.attr.name,c.value);break;case"node":$(d).text(c.value);break;default:throw new Error("jom: unexpected handle type")}for(l=a.events,m=[],g=0,i=l.length;i>g;g++)e=l[g],m.push("change"===e.type&&e.path===j?e.callback.call(a):void 0);return m}}}(this)):void 0);return e}},d.prototype.handlebars=function(a,c){var d,e;return e=c.collection,d=$(a),d.findAll("*").not("script, style, link, [repeat]").filter(function(){return 0===$(this).parents("[repeat]").length}).each(function(a){return function(c,d){var f,g,h,i,j,k,l,m;for(m=$(d).text(),0===$(d).children().length&&b.test(m)===!0&&(h=m.match(b)[1],k=e.join(a.path,h),j=e.findByPath($.trim(k)),void 0===j&&"production"===jom.env&&(j=""),$(d).text(m.replace(b,j)),d.handle={type:"node",path:k,full:e.join(e.name,k)},a.handles.push(d)),l=d.attributes,h=g=0,i=l.length;i>g;h=++g)f=l[h],b.test(f.value)&&(m=f.value,h=m.match(b)[1],k=e.join(a.path,h),j=e.findByPath($.trim(k)),void 0===j&&"production"===jom.env&&(j=""),f.value=m.replace(b,j),d.handle={attr:f,type:"attr",path:k,full:e.join(e.name,k)},a.handles.push(d));return d}}(this)),d},d.prototype.handle_template_scripts=function(a){var b,c;return this.scripts.status="waiting",b=function(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},c=$(a).find("script"),$(c).filter("[src]").each(function(a,b){return b.onload=function(){return b.has_loaded=!0}}),$(c).not("[src]").eq(0).each(function(a,c){var d,e,f;return d="",f=new RegExp("^"+b(d)),e=f.test(c.text),c.text="(function(){\nvar\nshadow     = jom.shadow,\nbody       = shadow.body,\nhost       = shadow.host,\nroot       = shadow.root,\ncomponent  = host.component,\ncollection = component.collection,\ndata       = component.collection.findByPath(component.path)\n;\n\n"+c.text+"\n})()",c})},d.prototype.on=function(a,b,c){var d,e,f,g;for(g=a.split(" "),e=0,f=g.length;f>e;e++)a=g[e],d={type:a,path:b,callback:c},this.events.push(d);return this},d.prototype.trigger=function(a,b){var c,d,e,f,g,h,i,j,k,l,m;for(null==b&&(b={}),m=a.split(" "),e=0,h=m.length;h>e;e++)for(a=m[e],k=this.events,f=0,i=k.length;i>f;f++)if(c=k[f],a===c.type)for(l=this.handles,g=0,j=l.length;j>g;g++)d=l[g],-1!==d.handle.path.indexOf(c.path)&&c.callback.call(d,c,b);return this},d.prototype.repeat=function(a,c){var d,e,f,g,h,i,j,k,l,m,n;if(null==c&&(c=null),null===c&&(c=this.data),d=$(a),i=d.attr("repeat"),void 0===i)throw new Error("component: items attr missing");for(i=i.match(b)[1],m=$('<div repeated="true" />'),k=this.collection.join(this.path,i),c=this.collection.findByPath(k),f=h=0,j=c.length;j>h;f=++h)g=c[f],e=d.clone(),e.attr("repeated",!0),e.attr("repeat",null),e.attr("repeat-index",f),l=this.collection.join(i,"["+f+"]"),n=e[0].outerHTML.replace(/(\${)([^\s{}]+)(})/g,"$1"+l+".$2$3"),m.append(n);return m},d}();var Template;Template=function(){function a(a){var b,c;if(null==a&&(a=null),b=$(a),0===b.length)throw new Error("jom: template is required");if(this.name=b.attr("name"),void 0===this.name)throw new Error("jom: template name attr is required");if(c=b.get(0),this.element=document.importNode(c.content,!0),this.body=$(this.element).children("[body]"),b.get(0).template=!0,void 0===this.body||0===this.body.length)throw new Error("jom: template body attr is required");this.cloned=null}return a.prototype.clone=function(){return this.cloned=this.element.cloneNode(!0)},a}();var JOM,jom;JOM=function(){var a,b,c;b={},a={},c={};function d(){window.jom=this,$("html").append("<foot/>"),this.clear_cache(),this.clear_stack(),this.tasks(),this.env="production",this.app={title:"JOM is Awesome"}}return d.prototype.tasks=function(){return setTimeout(function(a){return function(){return a.load_assets(),a.load_components(),a.load_templates(),a.load_collections(),a.inject_assets(),a.assemble_components(),a.watch_collections(),a.tasks()}}(this),100)},d.prototype.inject_assets=function(){return $.each(c.asset,function(a,b){var c;return null!=b.queued!=!0?(b.queued=!0,c=$("html>foot"),"text/json"===b.content_type.part&&$.getJSON(b.source).done(function(a){return c.find("script[source='"+b.source+"']").get(0).data=a}),c.append(b.element)):void 0})},d.prototype.load_assets=function(){return $('head link[rel="asset"]').each(function(a,b){var d;return d=$(c.asset).filter(function(){return this.source===$(b).attr("source")}),"asset"in b==!1&&0===d.length?(b.asset=!0,c.asset.push(new Asset(b))):void 0})},d.prototype.load_components=function(){return $("component").each(function(a,b){var d;return"component"in b==!1?(b.component=!0,d=new Component(b),c.component.push(d),b.component=d):void 0})},d.prototype.load_templates=function(){return $("foot link[rel=import]").filter(function(a,b){return null!==b["import"]}).each(function(a,b){var d,e;return e=b["import"].querySelector("template"),"template"in e==!1&&void 0!==b["import"]?(e.template=!0,d=$(e).attr("name"),c.template[d]=new Template(e)):void 0})},d.prototype.load_collections=function(){return $("foot script[type='text/json']").each(function(a,b){var d,e;return"collection"in b==!1&&void 0!==b.data?(b.collection=!0,e=$(b).attr("name"),d=b.data,c.collection[e]=new Collection(e,d)):void 0})},d.prototype.assemble_components=function(){return $.each(c.component,function(a){return function(b,c){var d,e,f;return c.ready!==!0&&"init"===c.scripts.status&&(f=jom.template[c.attr.template],d=jom.collection[c.attr.collection],void 0!==f&&void 0!==d&&(null!=(e=d.data)?e.length:void 0))?(c.define_template(f),c.define_collection(d),c.template.clone(),a.repeater(c),c.hide(),c.root.appendChild($("<div>Loading...</div>").get(0)),c.handlebars(c.template.cloned,c),$(c.root.children).remove(),c.handle_template_scripts(c.template.cloned),c.root.appendChild(c.template.cloned),a.image_source_change(c),a.wait_for_scripts(c)):void 0}}(this))},d.prototype.wait_for_scripts=function(a){return"done"===a.scripts.status?(a.show(),a.ready=!0,a.trigger("ready")):setTimeout(function(b){return function(){var c,d;return c=!0,d=$("script[src]",a.root),$(d).each(function(a,b){return null!=b.has_loaded!=!0?c=!1:void 0}),c===!0&&(a.scripts.status="done"),b.wait_for_scripts(a)}}(this),10)},d.prototype.image_source_change=function(a){return $("[body] img",a.root).not("[repeat] img").each(function(a,b){var c;return c=$(b),c.attr("src",c.attr("source"))})},d.prototype.repeater=function(a,b){return null==b&&(b=null),$("[body] [repeat]",b||a.template.cloned).each(function(b,c){var d;return c=$(c),d=a.repeat(c),d.insertAfter(c),c.hide()})},d.prototype.watch_collections=function(){var a,b,d,e;d=c.collection,e=[];for(b in d)a=d[b],a.observing===!1?(a.observing=!0,e.push(new Observe(a.data,function(a){return function(d){var e,f;f=[];for(b in d)e=d[b],f.push($.each(c.component,function(b,c){return $(c.root).find("[repeated]").remove(),$(c.root).find("[repeat]").show(),a.repeater(c,c.root),c.handlebars(c.root,c),a.image_source_change(c),$(c.root.host).trigger("change",[e,c.data,c.collection]),$(c.root).find("[repeat]").hide(),c.trigger("change",e)}));return f}}(this)))):e.push(void 0);return e},d.prototype.resolve=function(a){var b,c,d,e,f,g;switch(c=location.href,d=c.replace(location.protocol+"//","").replace(location.host,""),g=d,b=a[0],f=a[1],e="",b){case"/":"/"!==f&&(e=a);break;default:e=g.replace(/([\/]?[^\/]+[\/]?)$/g,"/"+a)}return e},d.prototype.get_stack=function(){return c},d.prototype.get_cache=function(){return a},d.prototype.clear_stack=function(){return c.template={},c.collection={},c.component=[],c.asset=[]},d.prototype.clear_cache=function(){return a.template={},a.collection={},a.component=[],a.asset=[]},d.getter("asset",function(){return c.asset}),d.getter("shadow",function(){return new Shadow}),d.getter("template",function(){return c.template}),d.getter("component",function(){return c.component}),d.getter("collection",function(){return c.collection}),d}(),jom=JOM=new JOM;
//# sourceMappingURL=jom.min.js.map