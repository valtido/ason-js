<!DOCTYPE html>

<html>
<head>
  <title>source.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>source.coffee</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="coffeebar.html">
                    coffeebar.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="command.html">
                    command.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="source.html">
                    source.coffee
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        <p>External dependencies</p>

        
          <div class='highlight'><pre>fs     = require <span class="string">'fs'</span>
path   = require <span class="string">'path'</span>
mkdirp = require <span class="string">'mkdirp'</span>
xcolor = require <span class="string">'xcolor'</span>
coffee = require <span class="string">'coffee-script'</span>
uglify = require <span class="string">'uglify-js'</span></pre></div>
        
      
        
        <p>The Source class represents a file containing source code. It knows
how to read a file in, compile it, transform it, and then write it
out to a target file.</p>

        
          <div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Source</span></span></pre></div>
        
      
        
        <h2>Initialization</h2>

        
      
        
        <p>Initilization consists of setting the timestamps to zero, then resolving
the file name and reading it in.</p>

        
          <div class='highlight'><pre>  constructor: (<span class="property">@options</span>, <span class="property">@file</span> = <span class="string">""</span>) -&gt;
    <span class="property">@writeTime</span> = <span class="number">0</span>
    <span class="property">@compileTime</span> = <span class="number">0</span>
    <span class="property">@modTime</span> = <span class="number">0</span>

    <span class="keyword">if</span> <span class="property">@file</span>
      <span class="property">@inputFile</span> = path.resolve file
      <span class="property">@read</span>()</pre></div>
        
      
        
        <h2>Actions</h2>

        
      
        
        <p>Read in the source file from disk and store the number of lines for 
later use in reporting errors in joined filed.</p>

        
          <div class='highlight'><pre>  read: -&gt;
    <span class="property">@src</span> = fs.readFileSync <span class="property">@file</span>, <span class="string">'utf8'</span>
    <span class="property">@lines</span> = <span class="property">@src</span>.split(<span class="string">'\n'</span>).length
    <span class="property">@modTime</span> = <span class="keyword">new</span> Date().getTime()</pre></div>
        
      
        
        <p>Call the CoffeeScript compiler, and save the output. If there are any
errors, stash them for reporting later and continue on.</p>

        
          <div class='highlight'><pre>  compile: -&gt;
    <span class="keyword">try</span>
      <span class="property">@error</span> = <span class="literal">false</span>
      <span class="property">@compiled</span> = coffee.compile <span class="property">@src</span>, <span class="property">@getCompileOptions</span>()
      <span class="property">@compileTime</span> = <span class="keyword">new</span> Date().getTime()
    <span class="keyword">catch</span> err
      <span class="property">@error</span> = err.toString().replace <span class="regexp">/on line \d/</span>, <span class="string">''</span>
      <span class="property">@errorFile</span> = <span class="property">@file</span>
      line = <span class="regexp">/on line (\d)/</span>.exec(err)
      <span class="property">@errorLine</span> = <span class="keyword">if</span> line?[<span class="number">1</span>]? <span class="keyword">then</span> line[<span class="number">1</span>] <span class="keyword">else</span> <span class="number">0</span></pre></div>
        
      
        
        <p>Transform the compiled source by passing it through Uglify-JS.</p>

        
          <div class='highlight'><pre>  minify: -&gt;
    result = uglify.minify <span class="property">@compiled</span>, {fromString: <span class="literal">true</span>}
    <span class="property">@compiled</span> = result.code</pre></div>
        
      
        
        <p>Determines where this source should be written out to, creates the dirs
if needed, and then output it. Finally, send a snazzy success message to
the console.</p>

        
          <div class='highlight'><pre>  write: -&gt;
    <span class="property">@setOutputPath</span>()
    mkdirp.sync path.dirname(<span class="property">@outputPath</span>)
    fs.writeFileSync <span class="property">@outputPath</span>, <span class="property">@compiled</span>, <span class="string">'utf8'</span>
    <span class="property">@writeTime</span> = <span class="keyword">new</span> Date().getTime()

    <span class="keyword">unless</span> <span class="property">@options</span>.silent
      xcolor.log <span class="string">"  <span class="subst">#{(<span class="keyword">new</span> Date).toLocaleTimeString()}</span> - {{.boldCoffee}}Compiled{{/color}} {{.coffee}}<span class="subst">#{@outputPath}</span>"</span></pre></div>
        
      
        
        <h2>Utilities</h2>

        
      
        
        <p>Returns the currently set compiler options.</p>

        
          <div class='highlight'><pre>  getCompileOptions: -&gt;
    header: <span class="property">@options</span>.header
    bare: <span class="property">@options</span>.bare</pre></div>
        
      
        
        <p>Sends a log of this source&#39;s current error to the console.</p>

        
          <div class='highlight'><pre>  reportError: -&gt;
    xcolor.log <span class="string">"  <span class="subst">#{(<span class="keyword">new</span> Date).toLocaleTimeString()}</span> - {{bold}}{{.error}}<span class="subst">#{@errorFile}</span>:{{/bold}} <span class="subst">#{@error}</span> on line <span class="subst">#{@errorLine}</span>"</span></pre></div>
        
      
        
        <p>Sets the output path for this source based on a combination of the input
file and the passed in options.</p>

        
          <div class='highlight'><pre>  setOutputPath: -&gt;
    <span class="keyword">return</span> <span class="keyword">if</span> <span class="property">@outputPath</span>

    fileName = path.basename(<span class="property">@file</span>, <span class="string">'.coffee'</span>) + <span class="string">'.js'</span>
    dir = path.dirname <span class="property">@file</span>

    <span class="keyword">if</span> <span class="property">@options</span>.output
      dir = dir.replace <span class="property">@inputFile</span>, <span class="property">@options</span>.output

    <span class="property">@outputPath</span> = path.join dir, fileName</pre></div>
        
      
        
        <p>Returns true if this source has uncompiled changes.</p>

        
          <div class='highlight'><pre>  updated: -&gt;
    <span class="property">@modTime</span> &gt;= <span class="property">@compileTime</span></pre></div>
        
      
        
        <p>Returns true if this source has unwritten compiled changes.</p>

        
          <div class='highlight'><pre>  outputReady: -&gt;
    !<span class="property">@error</span> <span class="keyword">and</span> <span class="property">@compileTime</span> &gt;= <span class="property">@writeTime</span></pre></div>
        
      
        
        <h2>Exports</h2>

        
      
        
        <p>Export the Source class.</p>

        
          <div class='highlight'><pre>module.exports = Source</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
