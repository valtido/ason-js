<!DOCTYPE html>

<html>
<head>
  <title>coffeebar.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>coffeebar.coffee</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="coffeebar.html">
                    coffeebar.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="command.html">
                    command.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="source.html">
                    source.coffee
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        <h2>Coffeebar</h2>

        
      
        
        <p>Copyright (c) 2013 Charles Moncrief <a href="&#x6d;&#97;&#x69;&#x6c;&#116;&#111;&#x3a;&#99;&#x6d;&#x6f;&#110;&#99;&#114;&#105;&#x65;&#102;&#x40;&#103;&#109;&#x61;&#105;&#108;&#x2e;&#x63;&#111;&#109;">&#99;&#x6d;&#x6f;&#110;&#99;&#114;&#105;&#x65;&#102;&#x40;&#103;&#109;&#x61;&#105;&#108;&#x2e;&#x63;&#111;&#109;</a></p>
<p>MIT Licensed</p>
<p>Coffeebar is a minimalistic CoffeeScript build utility. It supports file
watching, minification and concatenation of source files. Coffeebar is
available as a command line utility and can also be used directly from the
public API.</p>
<p>External dependencies.</p>

        
          <div class='highlight'><pre>fs       = require <span class="string">'fs'</span>
path     = require <span class="string">'path'</span>
beholder = require <span class="string">'beholder'</span>
coffee   = require <span class="string">'coffee-script'</span>
glob     = require <span class="string">'glob'</span>
mkdirp   = require <span class="string">'mkdirp'</span>
xcolor   = require <span class="string">'xcolor'</span>
 
Source   = require <span class="string">'./source'</span></pre></div>
        
      
        
        <p>The Coffebar class is the main entry point of the API. Creating a new
instance will initialize and kick off a build.</p>

        
          <div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Coffeebar</span></span></pre></div>
        
      
        
        <h2>Initialization</h2>

        
      
        
        <p>Initialize the default options and the color scheme. The join option is
implied rather then specific. Once initial setup is completed, kick off
the initial build.</p>

        
          <div class='highlight'><pre>  constructor: (<span class="property">@inputPaths</span>, <span class="property">@options</span> = {}) -&gt;
    <span class="property">@sources</span> = []
    <span class="property">@options</span>.watch ?= <span class="literal">false</span>
    <span class="property">@options</span>.silent ?= <span class="literal">true</span>
    <span class="property">@options</span>.minify ?= <span class="literal">false</span>
    <span class="property">@options</span>.join = <span class="literal">true</span> <span class="keyword">if</span> <span class="property">@options</span>.output <span class="keyword">and</span> path.extname(<span class="property">@options</span>.output)

    <span class="property">@options</span>.bare ?= <span class="literal">false</span>
    <span class="property">@options</span>.header ?= <span class="literal">true</span>

    <span class="property">@initColors</span>()
    <span class="property">@initPaths</span>()

    <span class="property">@start</span>()</pre></div>
        
      
        
        <p>Prepare the specified input paths to be scanned by glob by assuming that
we actually want to compile the entire directory tree that was passed in,
unless an actual filename was passed in.</p>

        
          <div class='highlight'><pre>  initPaths: -&gt;
    <span class="keyword">unless</span> Array.isArray(<span class="property">@inputPaths</span>) <span class="keyword">then</span> <span class="property">@inputPaths</span> = [<span class="property">@inputPaths</span>]

    <span class="keyword">for</span> inputPath, i <span class="keyword">in</span> <span class="property">@inputPaths</span>
      <span class="keyword">unless</span> path.extname(inputPath)
        <span class="property">@inputPaths</span>[i] = <span class="string">"<span class="subst">#{inputPath}</span>/**/*.coffee"</span>

    <span class="property">@inputPaths</span> = (i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="property">@inputPaths</span> <span class="keyword">when</span> path.extname(i) <span class="keyword">is</span> <span class="string">'.coffee'</span>)</pre></div>
        
      
        
        <p>Find all the src files in the input trees and create a new representation
of them via the Source class.</p>

        
          <div class='highlight'><pre>  addSources: -&gt;
    <span class="keyword">for</span> inputPath <span class="keyword">in</span> <span class="property">@inputPaths</span>
      files = glob.sync inputPath
      <span class="property">@sources</span>.push(<span class="keyword">new</span> Source(<span class="property">@options</span>, file)) <span class="keyword">for</span> file <span class="keyword">in</span> files</pre></div>
        
      
        
        <p>Start-up the initial process by adding the sources, building them,
and starting a watch on them if specified. This is only called once,
subsequent builds will be called directly from the watch process.</p>

        
          <div class='highlight'><pre>  start: -&gt;
    <span class="property">@addSources</span>()
    <span class="property">@build</span>()

    <span class="keyword">if</span> <span class="property">@options</span>.watch
      <span class="property">@watch</span> i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="property">@inputPaths</span></pre></div>
        
      
        
        <h2>Build</h2>

        
      
        
        <p>Compile and write out all of the sources in our collection, transforming
and reporting errors along the way.</p>

        
          <div class='highlight'><pre>  build: -&gt;
    <span class="property">@compileSources</span>()
    <span class="property">@minifySources</span>() <span class="keyword">if</span> <span class="property">@options</span>.minify
    <span class="property">@reportErrors</span>()
    <span class="property">@writeSources</span>()</pre></div>
        
      
        
        <p>Compile each source in the collection if it has been updated
more recently than the last time it was written out. If this
build is targetting a joined file, join all of the sources
prior to compilation.</p>

        
          <div class='highlight'><pre>  compileSources: -&gt;
    <span class="property">@outputs</span> = <span class="keyword">if</span> <span class="property">@options</span>.join <span class="keyword">then</span> <span class="property">@joinSources</span>() <span class="keyword">else</span> <span class="property">@sources</span>

    source.compile() <span class="keyword">for</span> source <span class="keyword">in</span> <span class="property">@outputs</span> <span class="keyword">when</span> source.updated</pre></div>
        
      
        
        <p>Minify each source in the collection if it was compiled without
errors more recently than it was written out.</p>

        
          <div class='highlight'><pre>  minifySources: -&gt;
    source.minify() <span class="keyword">for</span> source <span class="keyword">in</span> <span class="property">@outputs</span> <span class="keyword">when</span> source.outputReady()</pre></div>
        
      
        
        <p>After compilation, report each error that was logged. In the event
that this is a joined output file, use the line number offset to
detect which input file the error actually occurred in.</p>

        
          <div class='highlight'><pre>  reportErrors: -&gt;
    <span class="keyword">if</span> <span class="property">@options</span>.join <span class="keyword">and</span> <span class="property">@outputs</span>[<span class="number">0</span>].error
      offset = <span class="number">0</span>
      <span class="keyword">for</span> source <span class="keyword">in</span> <span class="property">@sources</span>
        <span class="keyword">if</span> offset + source.lines &gt; <span class="property">@outputs</span>[<span class="number">0</span>].errorLine
          errorFile = source.file
          <span class="keyword">break</span>
        <span class="keyword">else</span>
          offset += source.lines

      <span class="property">@outputs</span>[<span class="number">0</span>].errorLine = <span class="property">@outputs</span>[<span class="number">0</span>].errorLine - offset
      <span class="property">@outputs</span>[<span class="number">0</span>].errorFile = errorFile

    source.reportError() <span class="keyword">for</span> source <span class="keyword">in</span> <span class="property">@outputs</span> <span class="keyword">when</span> source.error</pre></div>
        
      
        
        <p>Write out each source in the collection if it was compiled without
error more recently than it was written out.</p>

        
          <div class='highlight'><pre>  writeSources: -&gt;
    source.write() <span class="keyword">for</span> source <span class="keyword">in</span> <span class="property">@outputs</span> <span class="keyword">when</span> source.outputReady()</pre></div>
        
      
        
        <h2>Watch</h2>

        
      
        
        <p>Watch an input path for changes, additions and removals. When
an event is triggered, add or remove the source and kick off
a build.</p>

        
          <div class='highlight'><pre>  watch: (inputPath) -&gt;
    watcher = beholder inputPath

    watcher.<span class="literal">on</span> <span class="string">'change'</span>, (file) =&gt;
      source = <span class="property">@getSource</span> file
      source.read()
      <span class="property">@build</span>()

    watcher.<span class="literal">on</span> <span class="string">'new'</span>, (file) =&gt;
      <span class="property">@sources</span>.push(<span class="keyword">new</span> Source(<span class="property">@options</span>, file))
      <span class="property">@build</span>()

    watcher.<span class="literal">on</span> <span class="string">'remove'</span>, (file) =&gt;
      <span class="property">@sources</span> = (i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="property">@sources</span> <span class="keyword">when</span> i.file <span class="keyword">isnt</span> file)
      <span class="property">@build</span>() <span class="keyword">if</span> <span class="property">@options</span>.join</pre></div>
        
      
        
        <h2>Utilities</h2>

        
      
        
        <p>Join all sources by concatenating the input src code and return
an array with only the newly joined source element for output.</p>

        
          <div class='highlight'><pre>  joinSources: -&gt;
    joinSrc = <span class="string">""</span>
    joinSrc = joinSrc.concat(i.src + <span class="string">"\n"</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="property">@sources</span>

    joinSource = <span class="keyword">new</span> Source(<span class="property">@options</span>)
    joinSource.src = joinSrc
    joinSource.outputPath = <span class="property">@options</span>.output
    [joinSource]</pre></div>
        
      
        
        <p>Retrieves the source in our collection by file name.</p>

        
          <div class='highlight'><pre>  getSource: (file) -&gt;
    <span class="keyword">return</span> i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="property">@sources</span> <span class="keyword">when</span> i.file <span class="keyword">is</span> file</pre></div>
        
      
        
        <p>Initialize our CLI theme with some sharp looking colors.</p>

        
          <div class='highlight'><pre>  initColors: -&gt;
    xcolor.addStyle coffee     : <span class="string">'chocolate'</span>
    xcolor.addStyle boldCoffee : [<span class="string">'bold'</span>, <span class="string">'chocolate'</span>]
    xcolor.addStyle error      : <span class="string">'crimson'</span></pre></div>
        
      
        
        <h2>Exports</h2>

        
      
        
        <p>Export a new instance of Coffeebar.</p>

        
          <div class='highlight'><pre>module.<span class="function"><span class="title">exports</span></span> = (inputPaths, options) -&gt;
  <span class="keyword">new</span> Coffeebar inputPaths, options</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
